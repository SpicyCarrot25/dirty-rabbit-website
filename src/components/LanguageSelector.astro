---
import { languages, getLocalizedPath, type Language } from '../i18n';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;

// Get current path without language prefix
const cleanPath = Astro.url.pathname.replace(/^\/(en|ca)(\/|$)/, '/').replace(/^\//, '');
const currentPath = cleanPath || '/';

const langNames: Record<Language, string> = {
  es: 'ES',
  en: 'EN',
  ca: 'CA'
};
---

<!-- Dropdown language selector -->
<div class="lang-selector relative">
  <button 
    class="lang-btn flex items-center gap-1 font-mono text-sm px-2 py-1 rounded hover:bg-black/5 transition-colors"
    aria-label="Select language"
    aria-expanded="false"
  >
    <span class="font-bold text-red">{langNames[lang]}</span>
    <svg class="w-3 h-3 text-black/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>
  
  <div class="lang-dropdown hidden absolute right-0 top-full mt-1 bg-white border border-black/20 rounded-lg shadow-lg min-w-[60px] z-[200] overflow-hidden">
    {languages.map((l) => (
      <a 
        href={getLocalizedPath(currentPath, l)}
        class:list={[
          "block px-3 py-2 font-mono text-sm hover:bg-cream transition-colors text-center",
          l === lang ? "text-red font-bold bg-cream/50" : "text-black"
        ]}
      >
        {langNames[l]}
      </a>
    ))}
  </div>
</div>

<script>
  // Initialize all language selectors on the page
  document.querySelectorAll('.lang-selector').forEach(selector => {
    const btn = selector.querySelector('.lang-btn');
    const dropdown = selector.querySelector('.lang-dropdown');
    
    btn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdown?.classList.contains('hidden');
      
      // Close all other dropdowns first
      document.querySelectorAll('.lang-dropdown').forEach(d => d.classList.add('hidden'));
      document.querySelectorAll('.lang-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
      
      if (isHidden) {
        dropdown?.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
      }
    });
  });
  
  // Close on outside click
  document.addEventListener('click', () => {
    document.querySelectorAll('.lang-dropdown').forEach(d => d.classList.add('hidden'));
    document.querySelectorAll('.lang-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
  });
  
  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.lang-dropdown').forEach(d => d.classList.add('hidden'));
      document.querySelectorAll('.lang-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
    }
  });
</script>
