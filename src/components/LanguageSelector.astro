---
import { languages, getLocalizedPath, type Language } from '../i18n';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;

// Get current path without language prefix
const currentPath = Astro.url.pathname.replace(/^\/(en|ca)\//, '/').replace(/^\/(en|ca)$/, '/');

const langNames: Record<Language, string> = {
  es: 'ES',
  en: 'EN',
  ca: 'CA'
};
---

<div class="relative" id="lang-selector">
  <button 
    class="flex items-center gap-1 font-mono text-xs hover:text-red transition-colors"
    aria-label="Select language"
    id="lang-btn"
  >
    <span>{langNames[lang]}</span>
    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>
  
  <div 
    id="lang-dropdown"
    class="hidden absolute right-0 top-full mt-2 bg-cream border border-black/20 shadow-lg min-w-[60px] z-50"
  >
    {languages.map((l) => (
      <a 
        href={getLocalizedPath(currentPath, l)}
        class:list={[
          "block px-3 py-2 font-mono text-xs hover:bg-black/5 transition-colors",
          l === lang && "text-red font-bold"
        ]}
        data-lang={l}
      >
        {langNames[l]}
      </a>
    ))}
  </div>
</div>

<script>
  const btn = document.getElementById('lang-btn');
  const dropdown = document.getElementById('lang-dropdown');
  
  btn?.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdown?.classList.toggle('hidden');
  });
  
  // Close on outside click
  document.addEventListener('click', () => {
    dropdown?.classList.add('hidden');
  });
  
  // Save language preference
  document.querySelectorAll('[data-lang]').forEach(link => {
    link.addEventListener('click', () => {
      const lang = link.getAttribute('data-lang');
      if (lang) {
        localStorage.setItem('preferredLang', lang);
      }
    });
  });
</script>
